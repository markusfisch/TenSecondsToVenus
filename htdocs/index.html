<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Ten Seconds To Venus</title>
<link rel="shortcut icon" href="icon.png"/>
<style>

body
{
	background: #000;
	margin: 0; padding: 0;
	font: 12pt monospace; color: #fff;
	letter-spacing: .01em;
	text-align: center;
	overflow: hidden;
}

#Intro
{
	padding: 2em;
}

#StartButton
{
	display: block;
	margin: 0 auto; padding: 1em 1.2em;
	width: 10em;
	text-decoration: none;
	border: .2em solid #fff;
	border-radius: .1em;
}

a
{
	color: #bbb;
}

.Loading
{
	color: #fff;
}

.Ready
{
	background: #fff;
	color: #000;
}

small
{
	color: #888;
}

canvas
{
	z-index: 0;
	position: fixed;
	left: 0; top: 0;
}

.Hud
{
	position: fixed;
	padding: 1em 0;
	left: 0; top: 0;
	width: 100%;
	z-index: 1;
}

.Message
{
	position: fixed;
	top: 0; left: 0;
	z-index: 2;
	width: 100%; height: 100%;
	line-height: 1.5;
	text-align: center;
	overflow: auto;
}

.Message::after
{
	content: "";
	position: absolute;
	top: 0; left: 0;
	bottom: 0; right: 0;
	background: #000;
	opacity: .8;
	z-index: -1;
}

p
{
	margin: 0 auto; padding: 1em;
	max-width: 40em;
}

@media screen and (max-width: 640px)
{
	body
	{
		font-size: 80%;
	}

	#Intro
	{
		padding: 1em;
	}

	#StartButton
	{
		margin: 1em auto; padding: .5em .6em;
	}

	.Message img
	{
		width: 128px;
		height: 128px;
	}
}

@media screen and (max-width: 320px)
{
	body
	{
		font-size: 70%;
	}

	#Intro
	{
		padding: .25em;
	}

	#StartButton
	{
		margin: .5em auto; padding: .25em .3em;
	}
}

</style>
<head>
<body>
<div id="Intro">
<h1>Ten Seconds To Venus</h1>
<p>You are on board of a space station in Venus orbit.</p>
<p>You are sleeping.</p>
<p>You wake from a roaring <big>BANG!</big></p>
<p><a href="javascript:start()"
	id="StartButton"
	class="Loading">(Loading)</a></p>
<p><small>This game was made for
<a href="http://www.ludumdare.com/">Ludum Dare</a> #27 "10 Seconds".<br/>
Enhanced post-compo version. Original
<a href="http://www.ludumdare.com/compo/ludum-dare-27/?uid=19466">here</a>.<br/>
Source on
<a href="http://github.com/markusfisch/TenSecondsToVenus">GitHub</a>.</small></p>
</div>
<script>

"use strict";

var requestAnimFrame =
		window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		window.requestAnimationFrame ||
		function( callback )
		{
			window.setTimeout( callback, 16 );
		},
	objects = {
		venus: {
			draw: drawVenus,
			offset: 0,
			distance: 0,
			angle: 0,
			scale: 2,
			res: [{/*venus*/x:0,y:1182,w:512,h:512}] },
		station: {
			draw: drawStation,
			res: [
				{/*station*/x:0,y:909,w:1024,h:273},
				{/*station_burned*/x:0,y:636,w:1024,h:273}] },
		boosterTop: {
			ox: -371,
			oy: -168,
			draw: drawBooster,
			res: [{/*booster_top*/x:571,y:1493,w:59,h:63}] },
		boosterBottom: {
			ox: 249,
			oy: 162,
			draw: drawBooster,
			res: [{/*booster_bottom*/x:512,y:1493,w:59,h:65}] },
		water: {
			use: function()
			{
				say( "It's getting hot so why not drink something? "+
					"Gulp, gulp, ahh, better." );
				return false;
			},
			ox: 116,
			oy: -39,
			index: 0,
			res: [{/*item_water*/x:1052,y:365,w:19,h:32}] },
		food: {
			use: function()
			{
				say( "Yam, yam. Now to more important things." );
				return true;
			},
			ox: -91,
			oy: -11,
			index: 0,
			res: [{/*item_food*/x:1024,y:819,w:44,h:33}] },
		medpack: {
			use: function()
			{
				say( "Always good to have." );
				return true;
			},
			ox: 156,
			oy: 33,
			index: 0,
			res: [{/*item_medpack*/x:1024,y:909,w:51,h:38}] },
		screwdriver: {
			use: function()
			{
				var m;

				if( objects.astronaut.inventory.computer )
					m = "That doesn't work, it's too big to "+
						"fix the computer";
				else
					m = "Got it, what now?";

				say( m );
				return true;
			},
			ox: -71,
			oy: 27,
			index: 0,
			res: [{/*item_screwdriver*/x:1024,y:887,w:35,h:22}] },
		pen: {
			use: function()
			{
				if( objects.astronaut.inventory.computer )
				{
					objects.astronaut.inventory.pen = true;
					fireBoosters();
					say( "Wait, the pen fits in that restart "+
						"hole of the computer, YES!" );
					return true;
				}

				say( "What good is a pen right now? "+
					"Make a testament?" );
				return false;
			},
			ox: -8,
			oy: 24,
			index: 0,
			res: [{/*item_pen*/x:1052,y:331,w:21,h:34}] },
		manual: {
			use: function()
			{
				say( "Well, lets see, something about boosters..." );
				return true;
			},
			ox: -142,
			oy: 28,
			index: 0,
			res: [{/*item_manual*/x:1024,y:776,w:39,h:43}] },
		helmet: {
			use: function()
			{
				objects.astronaut.inventory.helmet = true;

				if( !objects.astronaut.inventory.suit )
					say( "Where's my suit?" );
				else
					say( "Ok, now I'm safe, I guess" );

				return true;
			},
			ox: -140,
			oy: -45,
			index: 0,
			res: [{/*item_helmet*/x:1024,y:688,w:42,h:47}] },
		suit: {
			use: function()
			{
				objects.astronaut.inventory.suit = true;

				if( !objects.astronaut.inventory.helmet )
					say( "Where's my helmet?" );
				else
					say( "That's a good idea!" );

				return true;
			},
			ox: 54,
			oy: -13,
			index: 0,
			res: [{/*item_suit*/x:945,y:1182,w:75,h:132}] },
		sleepbag: {
			use: function()
			{
				say( "Got it." );
				return true;
			},
			ox: -340,
			oy: 15,
			index: 0,
			res: [{/*item_sleepbag*/x:941,y:1343,w:81,h:95}] },
		wires: {
			use: function()
			{
				say( "Got them. They are red." );
				return true;
			},
			ox: -297,
			oy: 15,
			index: 0,
			res: [{/*item_wires*/x:1024,y:947,w:28,h:43}] },
		lamp: {
			use: function()
			{
				say( "Ok, now I have light!" );
				objects.lamp.index = 1;
			},
			ox: -28,
			oy: -55,
			index: 0,
			res: [
				{/*item_lamp*/x:1024,y:990,w:27,h:27},
				{/*item_lamp_on*/x:1024,y:735,w:41,h:41}] },
		camera: {
			use: function()
			{
				say( "Should I take a picture or what?" );
				return true;
			},
			ox: -333,
			oy: -62,
			index: 0,
			res: [{/*item_camera*/x:1051,y:990,w:25,h:25}] },
		computer: {
			use: function()
			{
				var m;

				objects.astronaut.inventory.computer = true;

				if( objects.astronaut.inventory.pen )
				{
					fireBoosters();
					m = "Oh, the pen fits in that restart hole, YEAH!";
				}
				else
					m = "I could start the boosters! Oh no! It's BROKEN!";

				say( m );
				return true;
			},
			ox: 160,
			oy: -26,
			index: 0,
			res: [{/*item_computer*/x:1024,y:852,w:42,h:35}] },
		astronaut: {
			draw: drawAstronaut,
			ox: -248,
			oy: 0,
			index: 0,
			res: [
				{/*astronaut0*/x:655,y:1343,w:143,h:149},
				{/*astronaut1*/x:798,y:1343,w:143,h:148},
				{/*astronaut2*/x:512,y:1343,w:143,h:150},
				{/*astronaut_helmet*/x:657,y:1182,w:143,h:158},
				{/*astronaut_suit*/x:800,y:1182,w:145,h:152},
				{/*astronaut_suited*/x:512,y:1182,w:145,h:161}] },
		heat: {
			draw: drawHeat,
			res: [
				{/*heat*/x:0,y:331,w:1052,h:305},
				{/*heat_burning*/x:0,y:0,w:1076,h:331}] }
	},
	atlas,
	canvas,
	ctx,
	ratio,
	width,
	height,
	centerX,
	centerY,
	start,
	now,
	last,
	uptime,
	factor,
	tolerance,
	moving,
	floating,
	success = false,
	killed = false,
	fireBoostersUntil = 0,
	hud,
	hudGoodUntil = 0;

function fireBoosters()
{
	fireBoostersUntil = now+2000;
}

function say( what )
{
	if( !hud )
	{
		hud = document.createElement( "div" );
		hud.className = "Hud";
		document.body.appendChild( hud );
	}

	hudGoodUntil = new Date().getTime()+4000;
	hud.innerHTML = what;
}

function drawVenus( obj )
{
	var sprite = obj.sprites[0];

	if( !fireBoostersUntil ||
		now < fireBoostersUntil )
	{
		var m = .628;

		if( fireBoostersUntil )
			m *= 1/2000*(fireBoostersUntil-now);

		obj.angle += m*factor;

		var a = obj.angle,
			d = obj.distance;

		obj.x = (centerX+d*Math.cos( a )) | 0;
		obj.y = (centerY+d*Math.sin( a )) | 0;
	}

	drawSprite( sprite, obj.x, obj.y );
}

function drawStation( obj )
{
	drawSprite(
		obj.sprites[killed ? 1 : 0],
		centerX,
		centerY );
}

function drawBooster( obj )
{
	if( !fireBoostersUntil ||
		fireBoostersUntil < now )
		return;

	drawSprite(
		obj.sprites[0],
		centerX+obj.x,
		centerY+obj.y );
}

function drawAstronaut( obj )
{
	if( killed )
		return;

	var sprite,
		x,
		y = centerY+obj.y+Math.sin( now*.005 )*floating;

	if( obj.grab &&
		obj.grabDist != 0 )
	{
		var g = obj.grab;

		obj.x += obj.grabDist > 0 ? moving : -moving;

		if( (obj.grabDist > 0 && obj.x >= g.x) ||
			(obj.grabDist < 0 && obj.x <= g.x) )
		{
			if( g.use )
				g.taken = g.use();

			obj.x = g.x;
			obj.grab = null;
		}
	}

	// pick sprite
	{
		var inv = obj.inventory;

		x = centerX+obj.x | 0;

		if( inv.helmet && inv.suit )
			sprite = obj.sprites[5];
		else if( inv.helmet )
			sprite = obj.sprites[3];
		else if( inv.suit )
			sprite = obj.sprites[4];
		else
			sprite = obj.sprites[
				fireBoostersUntil ?
				0 :
				Math.round( now/500 )%3];
	}

	drawSprite( sprite, x, y );
}

function drawHeat( obj )
{
	var b = 1;

	if( fireBoostersUntil )
	{
		if( fireBoostersUntil > now )
			b = 1/2000*(fireBoostersUntil-now);
		else
			b = 0;
	}

	if( uptime < 10000 )
	{
		var m = 1/10000*uptime;

		m *= b;

		ctx.globalAlpha = m;
		drawSprite( obj.sprites[0], centerX, centerY );
		ctx.globalAlpha = 1;
	}

	if( uptime > 9000 &&
		uptime < 12000 )
	{
		var m = 1/3000*(uptime-9000);

		m *= b;

		ctx.globalAlpha = Math.min( m, 1-m )*2;
		drawSprite( obj.sprites[1], centerX, centerY );
		ctx.globalAlpha = 1;
	}
}

function drawSprite( sprite, x, y )
{
	ctx.drawImage(
		sprite,
		(x-sprite.centerX) | 0,
		(y-sprite.centerY) | 0 );
}

function draw()
{
	ctx.clearRect( 0, 0, width, height );

	if( uptime > 10000 &&
		!killed &&
		!fireBoostersUntil )
	{
		say( "AAAARGHHHH!!" );
		killed = true;
	}

	if( !success &&
		fireBoostersUntil &&
		fireBoostersUntil < now )
	{
		var e = document.createElement( "div" );
		e.className = "Message";
		e.innerHTML =
			'<h2>Well done!</h2>'+
			'<img src="patch.png" alt="Patch"/>';
		document.body.appendChild( e );

		success = true;
	}

	for( var name in objects )
	{
		var obj = objects[name];

		if( obj.draw )
			obj.draw( obj );
		else if(
			!killed &&
			!obj.taken )
		{
			var sprite = obj.sprites[obj.index],
				x = centerX+obj.x,
				y = centerY+obj.y+Math.sin(
					now*.005+obj.x )*floating;

			obj.left = x-sprite.centerX;
			obj.top = y-sprite.centerY;
			obj.right = x+sprite.centerX;
			obj.bottom = y+sprite.centerY;

			ctx.drawImage( sprite, obj.left | 0, obj.top | 0 );
		}
	}

	if( hudGoodUntil &&
		hudGoodUntil < now )
	{
		hudGoodUntil = 0;
		hud.innerHTML = "";
	}
}

function run()
{
	now = new Date().getTime();
	uptime = now-start;
	factor = (now-last)/1000;
	last = now;

	draw();

	requestAnimFrame( run );
}

function click( ev )
{
	if( fireBoostersUntil )
	{
		ev.preventDefault();
		return false;
	}
	else if( killed  )
	{
		if( uptime > 12000 )
			reset();

		ev.preventDefault();
		return false;
	}

	var x,
		y;

	if( ev.touches )
	{
		var t = ev.touches[0];

		x = t.pageX;
		y = t.pageY;
	}
	else if( document.all )
	{
		x = event.clientX;
		y = event.clientY;
	}
	else
	{
		x = ev.pageX;
		y = ev.pageY;
	}

	x = x*ratio | 0;
	y = y*ratio | 0;

	var chosen = null,
		closest = tolerance;

	for( var name in objects )
	{
		var obj = objects[name],
			left = obj.left,
			right = obj.right,
			top = obj.top,
			bottom = obj.bottom;

		if( obj.taken ||
			typeof obj.left === "undefined" )
			continue;

		// pointer inside object rectangle
		if( x >= left &&
			x <= right &&
			y >= top &&
			y <= bottom )
		{
			chosen = obj;
			break;
		}

		// find closest object edge to pointer
		if( Math.abs( y-top ) < closest ||
			Math.abs( y-bottom ) < closest )
		{
			var dl = Math.abs( x-left ),
				dr = Math.abs( x-right );

			if( dl < closest )
			{
				chosen = obj;
				closest = dl;
			}
			else if( dr < closest )
			{
				chosen = obj;
				closest = dr;
			}
		}
	}

	if( chosen )
	{
		var a = objects.astronaut;

		a.grab = chosen;
		a.grabDist = chosen.x-a.x;
	}

	ev.preventDefault();
	return false;
}

function reset()
{
	start = new Date().getTime();
	last = start-16;
	success = false;
	killed = false;
	fireBoostersUntil = 0;
	hudGoodUntil = 0;

	for( var name in objects )
	{
		var obj = objects[name];

		if( typeof obj.ox !== "undefined" )
			obj.taken = false;
	}

	// reset lamp
	objects.lamp.index = 0;

	// reset astronaut
	{
		var a = objects.astronaut;

		a.grab = null;
		a.inventory = {};
		a.x = a.startX;
		a.y = a.startY;
	}
}

function scale( styleWidth )
{
	var scale,
		ref = objects.heat.res[1].w;

	if( styleWidth >= ref )
		scale = 1;
	else
		scale = width/ref;

	for( var name in objects )
	{
		var obj = objects[name],
			res = obj.res;

		obj.sprites = {};

		for( var n = res.length; n--; )
		{
			var bounds = obj.res[n],
				w = bounds.w*scale | 0,
				h = bounds.h*scale | 0,
				image,
				context;

			if( !(image = document.createElement( "canvas" )) ||
				!(context = image.getContext( "2d" )) )
				continue;

			if( typeof obj.scale !== "undefined" )
			{
				w = w*obj.scale | 0;
				h = h*obj.scale | 0;

				// don't make sprites bigger than 3 megapixels
				// (can only happen on high dpi displays)
				// because that will slow down rendering on iOS
				if( w*h > 3000000 )
				{
					h = (1200/w*h) | 0;
					w = 1200;
				}
			}

			image.width = w;
			image.height = h;

			image.centerX = w >> 1;
			image.centerY = h >> 1;

			context.drawImage(
				atlas,
				bounds.x | 0,
				bounds.y | 0,
				bounds.w | 0,
				bounds.h | 0,
				0 | 0,
				0 | 0,
				w | 0,
				h | 0 );

			obj.sprites[n] = image;
		}

		if( typeof obj.ox !== "undefined" )
		{
			obj.x = Math.round( obj.ox*scale );
			obj.y = Math.round( obj.oy*scale );
		}
	}

	moving = 10*scale;

	var a = objects.astronaut;
	a.startX = a.x;
	a.startY = a.y;
}

function resize()
{
	var styleWidth = window.innerWidth,
		styleHeight = window.innerHeight;

	if( width == styleWidth &&
		height == styleHeight )
		return;

	width = styleWidth*ratio | 0;
	height = styleHeight*ratio | 0;

	canvas.width = width;
	canvas.height = height;

	canvas.style.width = styleWidth+"px";
	canvas.style.height = styleHeight+"px";

	centerX = width >> 1;
	centerY = height >> 1;

	tolerance = 24*ratio | 0;

	var min = Math.min( width, height );
	floating = min*.005 | 0;
	objects.venus.distance = min*.25 | 0;

	scale( styleWidth );
}

function init()
{
	if( !(canvas = document.createElement( "canvas" )) ||
		!(ctx = canvas.getContext( "2d", { alpha: false } )) )
		return null;

	ratio =
		(window.devicePixelRatio || 1)/
		(ctx.webkitBackingStorePixelRatio ||
			ctx.mozBackingStorePixelRatio ||
			ctx.msBackingStorePixelRatio ||
			ctx.oBackingStorePixelRatio ||
			ctx.backingStorePixelRatio ||
			1)

	window.onresize = resize;
	resize();

	canvas.onmouseup = click;

	if( "ontouchstart" in document.documentElement )
	{
		canvas.ontouchstart = click;
		canvas.ontouchmove = function( ev )
		{
			ev.preventDefault();
			return false;
		};
	}

	document.body.appendChild( canvas );

	reset();
	run();
}

function start()
{
	if( !atlas.complete )
		return;

	// start loading patch in the background
	var patch = new Image();
	patch.src = "patch.png";

	document.getElementById( "Intro" ).style.display = "none";

	init();
}

function waitForAtlas()
{
	if( !atlas )
	{
		atlas = new Image();
		atlas.src = "atlas.png";
	}

	if( !atlas.complete )
	{
		setTimeout( waitForAtlas, 500 );
		return;
	}

	var e = document.getElementById( "StartButton" );
	e.className = "Ready";
	e.innerHTML = "Ready!";
}

window.onload = waitForAtlas;

</script>
</body>
</html>
